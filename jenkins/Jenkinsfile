pipeline {
  agent any

  environment {
    AWS_REGION   = "us-east-1"
    PROJECT      = "opentelemetryproject"
    ECR_REPO     = "opentelemetryproject/flask-hello"
    IMAGE_TAG    = "${BUILD_NUMBER}"   // <-- UPDATED
    K8S_NS       = "app"
    HELM_RELEASE = "flask-hello"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Resolve AWS Account + ECR URI') {
      steps {
        script {
          def acct = sh(returnStdout: true, script: "aws sts get-caller-identity --query Account --output text").trim()
          env.AWS_ACCOUNT_ID = acct
          env.ECR_URI = "${acct}.dkr.ecr.${env.AWS_REGION}.amazonaws.com/${env.ECR_REPO}"
        }
      }
    }

    stage('ECR Login + Ensure Repo') {
      steps {
        sh """
          aws ecr describe-repositories --repository-names "${ECR_REPO}" --region "${AWS_REGION}" >/dev/null 2>&1 \
          || aws ecr create-repository --repository-name "${ECR_REPO}" --region "${AWS_REGION}" >/dev/null

          aws ecr get-login-password --region "${AWS_REGION}" | \
            docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        """
      }
    }

    stage('Build + Push Image') {
      steps {
        sh """
          docker build -t ${PROJECT}:local ./app
          docker tag ${PROJECT}:local ${ECR_URI}:${IMAGE_TAG}
          docker push ${ECR_URI}:${IMAGE_TAG}
        """
      }
    }


stage('Debug Identity') {
  steps {
    sh '''
      set -euxo pipefail

      echo "=== AWS identity Jenkins is using ==="
      aws sts get-caller-identity

      echo "=== kubeconfig location ==="
      echo "HOME=$HOME"
      ls -la ~/.kube || true
      kubectl config current-context || true
      kubectl config view --minify -o jsonpath='{.users[0].user.exec.command}{" "}{.users[0].user.exec.args}{"\\n"}' || true

      echo "=== RBAC check ==="
      kubectl auth can-i create namespaces -A || true
    '''
  }
}


    stage('Deploy via Helm') {
      steps {
        sh """
          kubectl get ns ${K8S_NS} >/dev/null 2>&1 || kubectl create ns ${K8S_NS}

          helm upgrade --install ${HELM_RELEASE} ./helm/flask-hello \
            -n ${K8S_NS} \
            --set image.repository=${ECR_URI} \
            --set image.tag=${IMAGE_TAG}
        """
      }
    }

    stage('Show Ingress Address') {
      steps {
        sh """
          kubectl -n ${K8S_NS} get ingress
          kubectl -n ${K8S_NS} describe ingress flask-hello-ingress || true
        """
      }
    }
  }
}
